<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirana Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <style>
        body {
            font-family: "Inter", sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Beautiful gradient background with grocery image */
        .gradient-bg {
            background: linear-gradient(rgba(102, 126, 234, 0.85), rgba(118, 75, 162, 0.85)), 
                        url('https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="w-full bg-white shadow-sm p-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Kirana Store Management</h1>
            <button id="back-to-home" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors hidden">
                ‚Üê Back to Home
            </button>
        </div>
    </header>

    <!-- ===== LANDING PAGE ===== -->
    <div id="page-home" class="page active gradient-bg">
        <main class="w-full max-w-md mx-auto p-8">
            <div class="text-center mb-8 glass-effect rounded-2xl p-8 text-white">
                <h2 class="text-3xl font-bold mb-4">Welcome to Kirana Store</h2>
                <p class="text-blue-100 text-lg">Manage your store efficiently with our comprehensive tools</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showContentPage('sales')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üõçÔ∏è Sales</div>
                        <p class="text-blue-100">Sell products to customers and process orders</p>
                    </div>
                </button>
                
                <button onclick="showContentPage('purchase')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üì¶ Purchase</div>
                        <p class="text-green-100">Record product purchases from suppliers</p>
                    </div>
                </button>
                
                <button onclick="showContentPage('create')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">‚ûï Create Product</div>
                        <p class="text-purple-100">Add new products to your store inventory</p>
                    </div>
                </button>

                <!-- NEW: Delete Product Button -->
                <button onclick="showContentPage('delete-product')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üóëÔ∏è Delete Product</div>
                        <p class="text-red-100">Remove products from your store inventory</p>
                    </div>
                </button>

                <!-- UPDATED: All Products Stock with Filters -->
                <button onclick="showContentPage('all-products-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã All Products Stock</div>
                        <p class="text-teal-100">View complete stock details with filters</p>
                    </div>
                </button>

                <button onclick="showContentPage('sales-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã Sales Ledger</div>
                        <p class="text-red-100">View and manage all sales records</p>
                    </div>
                </button>
                
                <button onclick="showContentPage('purchase-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã Purchase Ledger</div>
                        <p class="text-indigo-100">View and manage all purchase records</p>
                    </div>
                </button>
            </div>
        </main>
    </div>

    <!-- ===== CONTENT PAGES ===== -->

    <!-- Sales Content Page -->
    <div id="page-sales" class="page">
        <main class="w-full max-w-md p-4 space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Products</h2>
            <div id="product-list" class="grid grid-cols-2 gap-4">
                <div class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>
            </div>
        </main>

        <!-- Cart Modal -->
        <div id="cart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-20">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Your Cart</h3>
                    <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="cart-items" class="space-y-3">
                    <!-- Cart items will be generated here by JavaScript -->
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total:</span>
                        <span id="cart-total">‚Çπ0.00</span>
                    </div>
                    <button id="whatsapp-checkout-button" class="w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300">
                        Checkout on WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Content Page -->
    <div id="page-purchase" class="page">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Products</h2>
            
            <!-- Purchase Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Record New Purchase</h3>
                <form id="purchase-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                        <select id="purchase-product" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" id="purchase-quantity" class="w-full p-2 border border-gray-300 rounded-lg" min="1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Cost (‚Çπ)</label>
                        <input type="number" id="purchase-unit-cost" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        Record Purchase
                    </button>
                </form>
            </div>

            <!-- Recent Purchases -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Recent Purchases</h3>
                <div id="purchase-history" class="space-y-3">
                    <!-- Purchase history will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Create Product Content Page -->
    <div id="page-create" class="page">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Create New Product</h2>
            
            <!-- Product Creation Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="create-product-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="product-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price (‚Çπ)</label>
                        <input type="number" id="product-price" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Stock</label>
                        <input type="number" id="product-stock" class="w-full p-2 border border-gray-300 rounded-lg" min="0" value="0">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        Create Product
                    </button>
                </form>
            </div>

            <!-- Existing Products -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Existing Products</h3>
                <div id="existing-products" class="space-y-3">
                    <!-- Existing products will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- NEW: Delete Product Content Page -->
    <div id="page-delete-product" class="page">
        <main class="w-full max-w-4xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Delete Product</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Products</h3>
                    <button onclick="loadDeleteProductPage()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Refresh Products
                    </button>
                </div>
                
                <!-- Warning Message -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Warning</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>Deleting a product will permanently remove it from your inventory. This action cannot be undone and will affect all related sales and purchase records.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="delete-product-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>

                <!-- Error State -->
                <div id="delete-product-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products</p>
                </div>

                <!-- Products List for Deletion -->
                <div id="delete-product-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="delete-product-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- UPDATED: All Products Stock Ledger Page with Filters -->
    <div id="page-all-products-ledger" class="page">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">All Products Stock</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Complete Stock Overview</h3>
                    <button onclick="loadAllProductsLedger()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">
                        Refresh
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="stock-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="stock-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="stock-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="flex space-x-2 w-full">
                            <button onclick="applyStockFilters()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                Apply
                            </button>
                            <button onclick="clearStockFilters()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="all-products-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading all products stock data...</p>
                </div>

                <!-- Error State -->
                <div id="all-products-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products stock data</p>
                </div>

                <!-- All Products Stock Content -->
                <div id="all-products-ledger-content" class="hidden">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-products">0</div>
                            <div class="text-sm text-gray-600">Total Products</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-stock">0</div>
                            <div class="text-sm text-gray-600">Total Stock</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600" id="low-stock-count">0</div>
                            <div class="text-sm text-gray-600">Low Stock Items</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="out-of-stock-count">0</div>
                            <div class="text-sm text-gray-600">Out of Stock</div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Stock Value (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="all-products-ledger-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Sales Ledger Page -->
    <div id="page-sales-ledger" class="page">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Sales Ledger</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Sales Records</h3>
                    <button onclick="loadSalesLedger()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Refresh
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="sales-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="sales-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="sales-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applySalesFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearSalesFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="sales-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading sales records...</p>
                </div>

                <!-- Error State -->
                <div id="sales-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading sales records</p>
                </div>

                <!-- Sales Records Table -->
                <div id="sales-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Amount (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-ledger-table-body">
                                <!-- Sales records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="sales-total-amount">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Purchase Ledger Page -->
    <div id="page-purchase-ledger" class="page">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Ledger</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Purchase Records</h3>
                    <button onclick="loadPurchaseLedger()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                        Refresh
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="purchase-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="purchase-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="purchase-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyPurchaseFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearPurchaseFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="purchase-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading purchase records...</p>
                </div>

                <!-- Error State -->
                <div id="purchase-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading purchase records</p>
                </div>

                <!-- Purchase Records Table -->
                <div id="purchase-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Unit Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchase-ledger-table-body">
                                <!-- Purchase records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="purchase-total-cost">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    // ===== BACKEND CONFIGURATION =====
    const backendURL = "https://kirana-store-maoc.onrender.com";
    const WHATSAPP_NUMBER = "917075210801";

    // Global variables
    let products = [];
    let cart = {};
    let allSalesData = [];
    let allPurchasesData = [];
    let allStockData = [];

    // DOM Elements
    const pages = {
        home: document.getElementById('page-home'),
        sales: document.getElementById('page-sales'),
        purchase: document.getElementById('page-purchase'),
        create: document.getElementById('page-create'),
        'delete-product': document.getElementById('page-delete-product'),
        'all-products-ledger': document.getElementById('page-all-products-ledger'),
        'sales-ledger': document.getElementById('page-sales-ledger'),
        'purchase-ledger': document.getElementById('page-purchase-ledger')
    };

    const backButton = document.getElementById('back-to-home');

    // ===== CORRECTED TIME FORMATTING UTILITY =====
    function formatDateTime(dateString) {
        if (!dateString) {
            return { date: 'N/A', time: 'N/A', full: 'N/A' };
        }
        
        try {
            const dateObj = new Date(dateString);
            
            if (isNaN(dateObj.getTime())) {
                console.warn('Invalid date:', dateString);
                return { date: 'Invalid Date', time: 'Invalid Date', full: 'Invalid Date' };
            }
            
            // Format as Indian date format without timezone conversion
            const day = dateObj.getDate().toString().padStart(2, '0');
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const year = dateObj.getFullYear().toString().slice(-2);
            
            const hours = dateObj.getHours().toString().padStart(2, '0');
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
            
            return {
                date: `${day}/${month}/${year}`,
                time: `${hours}:${minutes}`,
                full: `${day}/${month}/${year} ${hours}:${minutes}`
            };
        } catch (error) {
            console.error('Error formatting date:', error, dateString);
            return { date: 'Error', time: 'Error', full: 'Error' };
        }
    }

    // ===== NAVIGATION FUNCTIONS =====
    function showContentPage(pageName) {
        Object.values(pages).forEach(page => page.classList.remove('active'));
        pages[pageName].classList.add('active');
        backButton.classList.remove('hidden');
        loadPageData(pageName);
    }

    function backToHome() {
        Object.values(pages).forEach(page => page.classList.remove('active'));
        pages.home.classList.add('active');
        backButton.classList.add('hidden');
    }

    function loadPageData(pageName) {
        switch(pageName) {
            case 'sales':
                fetchProducts();
                break;
            case 'purchase':
                loadPurchasePage();
                break;
            case 'create':
                loadCreatePage();
                break;
            case 'delete-product':
                loadDeleteProductPage();
                break;
            case 'all-products-ledger':
                loadAllProductsLedger();
                break;
            case 'sales-ledger':
                loadSalesLedger();
                break;
            case 'purchase-ledger':
                loadPurchaseLedger();
                break;
        }
    }

    // ===== NEW: DELETE PRODUCT PAGE FUNCTIONS =====
    async function loadDeleteProductPage() {
        const loadingEl = document.getElementById('delete-product-loading');
        const errorEl = document.getElementById('delete-product-error');
        const contentEl = document.getElementById('delete-product-content');
        
        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');
        
        try {
            // Fetch all products
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch products');
            
            const products = await response.json();
            
            if (!Array.isArray(products) || products.length === 0) {
                throw new Error('No products found');
            }
            
            displayProductsForDeletion(products);
            
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error loading products for deletion:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<p class="text-red-500">Error loading products: ${error.message}</p>`;
        }
    }

    function displayProductsForDeletion(products) {
        const tableBodyEl = document.getElementById('delete-product-table-body');
        
        if (products.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No products found
                    </td>
                </tr>
            `;
            return;
        }
        
        // Sort products by ID
        products.sort((a, b) => a.id - b.id);
        
        // Generate table rows
        tableBodyEl.innerHTML = products.map(product => {
            const lastUpdated = product.last_updated || product.created_at || product.updated_at;
            const formattedDate = formatDateTime(lastUpdated);
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.id}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${product.price?.toFixed(2) || '0.00'}</td>
                    <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${product.stock || 0}</td>
                    <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                    <td class="border border-gray-200 px-4 py-2">
                        <button class="delete-product-btn text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                data-id="${product.id}" data-name="${product.name}">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ===== UPDATED DELETE PRODUCT FUNCTION =====
    async function deleteProduct(productId, productName) {
        if (!confirm(`Are you sure you want to delete "${productName}"? This action cannot be undone and will remove all associated sales and purchase records.`)) {
            return;
        }
        
        try {
            const deleteURL = `${backendURL}/products/${productId}`;
            
            console.log(`üóëÔ∏è Attempting to delete product from: ${deleteURL}`);
            
            const response = await fetch(deleteURL, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            console.log(`üìä Delete response status: ${response.status}`);
            
            if (response.ok) {
                const result = await response.json();
                showNotification(result.message || `Product "${productName}" deleted successfully!`);
                
                // Reload the delete product page
                await loadDeleteProductPage();
            } else {
                // Handle different HTTP status codes
                const errorData = await response.json().catch(() => ({}));
                
                if (response.status === 404) {
                    throw new Error('Product not found on server');
                } else if (response.status === 500) {
                    throw new Error(errorData.detail || 'Server error - please try again later');
                } else {
                    throw new Error(errorData.detail || `Server returned ${response.status}`);
                }
            }
            
        } catch (error) {
            console.error('Error deleting product:', error);
            alert(`‚ùå Error deleting product: ${error.message}`);
        }
    }

    // ===== MISSING FUNCTION: displayFilteredStockData =====
    function displayFilteredStockData(stockData) {
        const tableBodyEl = document.getElementById('all-products-ledger-table-body');
        const totalProductsEl = document.getElementById('total-products');
        const totalStockEl = document.getElementById('total-stock');
        const lowStockCountEl = document.getElementById('low-stock-count');
        const outOfStockCountEl = document.getElementById('out-of-stock-count');
        
        if (!stockData || stockData.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No stock data found for the selected filters
                    </td>
                </tr>
            `;
            totalProductsEl.textContent = '0';
            totalStockEl.textContent = '0';
            lowStockCountEl.textContent = '0';
            outOfStockCountEl.textContent = '0';
            return;
        }
        
        let totalProducts = 0;
        let totalStock = 0;
        let lowStockCount = 0;
        let outOfStockCount = 0;
        
        // Generate table rows
        tableBodyEl.innerHTML = stockData.map(product => {
            totalProducts++;
            totalStock += product.stock || 0;
            
            const stockValue = (product.price || 0) * (product.stock || 0);
            const lastUpdated = product.last_updated || product.created_at || product.updated_at;
            const formattedDate = formatDateTime(lastUpdated);
            
            let status = '';
            let statusClass = '';
            
            if (product.stock === 0) {
                outOfStockCount++;
                status = 'Out of Stock';
                statusClass = 'bg-red-100 text-red-800';
            } else if (product.stock <= 10) {
                lowStockCount++;
                status = 'Low Stock';
                statusClass = 'bg-yellow-100 text-yellow-800';
            } else {
                status = 'In Stock';
                statusClass = 'bg-green-100 text-green-800';
            }
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                    <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${product.stock || 0}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${(product.price || 0).toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${stockValue.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                    <td class="border border-gray-200 px-4 py-2">
                        <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status}</span>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Update summary statistics
        totalProductsEl.textContent = totalProducts;
        totalStockEl.textContent = totalStock;
        lowStockCountEl.textContent = lowStockCount;
        outOfStockCountEl.textContent = outOfStockCount;
    }

    // ===== UPDATED: ALL PRODUCTS LEDGER FUNCTIONS =====
    async function loadAllProductsLedger() {
        const loadingEl = document.getElementById('all-products-ledger-loading');
        const errorEl = document.getElementById('all-products-ledger-error');
        const contentEl = document.getElementById('all-products-ledger-content');
        
        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');
        
        try {
            // Use the new stock-snapshot endpoint
            const dateFrom = document.getElementById('stock-date-from').value;
            const dateTo = document.getElementById('stock-date-to').value;
            const productId = document.getElementById('stock-product-filter').value;
            
            // Build query parameters - ONLY include dates if they have values
            const params = new URLSearchParams();
            if (dateFrom && dateFrom.trim() !== '') params.append('date_from', dateFrom);
            if (dateTo && dateTo.trim() !== '') params.append('date_to', dateTo);
            if (productId && productId.trim() !== '') params.append('product_id', productId);
            
            const url = `${backendURL}/products/stock-snapshot?${params.toString()}`;
            
            console.log(`üìä Fetching stock snapshot from: ${url}`);
            
            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) {
                let errorMessage = `Failed to fetch stock data: ${response.status}`;
                
                // Try to get more detailed error information
                try {
                    const errorData = await response.json();
                    if (errorData.detail) {
                        errorMessage = errorData.detail;
                    }
                } catch (e) {
                    // If we can't parse JSON, use the status text
                    errorMessage = `Server error: ${response.status} ${response.statusText}`;
                }
                
                throw new Error(errorMessage);
            }
            
            allStockData = await response.json();
            console.log(`‚úÖ Received ${allStockData.length} stock records`);
            
            if (!Array.isArray(allStockData) || allStockData.length === 0) {
                // Show empty state instead of error
                displayFilteredStockData([]);
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                return;
            }
            
            // Load product dropdown for filter (if not already loaded)
            await loadProductDropdownForFilter('stock-product-filter');
            
            // Display the filtered data
            displayFilteredStockData(allStockData);
            
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error loading all products ledger:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `
                <div class="text-center">
                    <p class="text-red-500 font-semibold">Error loading products stock data</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                    <button onclick="clearStockFiltersAndReload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Clear Filters & Retry
                    </button>
                </div>
            `;
        }
    }

    // NEW: Separate function for clear button that actually works
    function clearStockFiltersAndReload() {
        document.getElementById('stock-date-from').value = '';
        document.getElementById('stock-date-to').value = '';
        document.getElementById('stock-product-filter').value = '';
        loadAllProductsLedger();
    }

    // Update the existing functions to use the new clear function
    function applyStockFilters() {
        loadAllProductsLedger();
    }

    function clearStockFilters() {
        clearStockFiltersAndReload();
    }

    // ===== SALES LEDGER FUNCTIONS =====
    async function loadSalesLedger() {
        const loadingEl = document.getElementById('sales-ledger-loading');
        const errorEl = document.getElementById('sales-ledger-error');
        const contentEl = document.getElementById('sales-ledger-content');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');
            
            try {
                const response = await fetch(`${backendURL}/ledger/sales`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch sales ledger');
                
                allSalesData = await response.json();
                console.log('üìä Sales data received:', allSalesData);
                
                // Load product dropdown for filter
                await loadProductDropdownForFilter('sales-product-filter');
                
                // Display all data initially
                displayFilteredSalesData(allSalesData);
                
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading sales ledger:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading sales records: ${error.message}</p>`;
            }
        }

    function displayFilteredSalesData(salesData) {
        const tableBodyEl = document.getElementById('sales-ledger-table-body');
        const totalAmountEl = document.getElementById('sales-total-amount');
        
        if (salesData.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No sales records found
                    </td>
                </tr>
            `;
            totalAmountEl.textContent = '‚Çπ0.00';
            return;
        }
        
        let totalAmount = 0;
        
        tableBodyEl.innerHTML = salesData.map(sale => {
            const formatted = formatDateTime(sale.date);
            const saleId = sale.sale_id || sale.id;
            const price = sale.unit_price || (sale.total_amount / sale.quantity) || 0;
            totalAmount += sale.total_amount;
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2">
                        <div class="text-sm font-medium">${formatted.date}</div>
                        <div class="text-xs text-gray-500">${formatted.time}</div>
                    </td>
                    <td class="border border-gray-200 px-4 py-2 text-sm">${saleId}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">${sale.product_name}</td>
                    <td class="border border-gray-200 px-4 py-2">${sale.quantity}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${price.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${sale.total_amount.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2">
                        <button class="delete-sale text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                data-id="${saleId}">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        totalAmountEl.textContent = `‚Çπ${totalAmount.toFixed(2)}`;
    }

    function applySalesFilters() {
        const dateFrom = document.getElementById('sales-date-from').value;
        const dateTo = document.getElementById('sales-date-to').value;
        const productId = document.getElementById('sales-product-filter').value;
        
        let filteredData = allSalesData;
        
        // Filter by date range
        if (dateFrom) {
            filteredData = filteredData.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate >= dateFrom;
            });
        }
        
        if (dateTo) {
            filteredData = filteredData.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate <= dateTo;
            });
        }
        
        // Filter by product
        if (productId) {
            filteredData = filteredData.filter(sale => sale.product_id == productId);
        }
        
        displayFilteredSalesData(filteredData);
    }

    function clearSalesFilters() {
        document.getElementById('sales-date-from').value = '';
        document.getElementById('sales-date-to').value = '';
        document.getElementById('sales-product-filter').value = '';
        displayFilteredSalesData(allSalesData);
    }

    // ===== PURCHASE LEDGER FUNCTIONS =====
    async function loadPurchaseLedger() {
        const loadingEl = document.getElementById('purchase-ledger-loading');
        const errorEl = document.getElementById('purchase-ledger-error');
        const contentEl = document.getElementById('purchase-ledger-content');
        
        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');
        
        try {
            const response = await fetch(`${backendURL}/ledger/purchases`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch purchase ledger');
            
            allPurchasesData = await response.json();
            console.log('üìä Purchases data received:', allPurchasesData);
            
            // Load product dropdown for filter
            await loadProductDropdownForFilter('purchase-product-filter');
            
            // Display all data initially
            displayFilteredPurchaseData(allPurchasesData);
            
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error loading purchase ledger:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<p class="text-red-500">Error loading purchase records: ${error.message}</p>`;
        }
    }

    function displayFilteredPurchaseData(purchasesData) {
        const tableBodyEl = document.getElementById('purchase-ledger-table-body');
        const totalCostEl = document.getElementById('purchase-total-cost');
        
        if (purchasesData.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No purchase records found
                    </td>
                </tr>
            `;
            totalCostEl.textContent = '‚Çπ0.00';
            return;
        }
        
        let totalCost = 0;
        
        tableBodyEl.innerHTML = purchasesData.map(purchase => {
            const formatted = formatDateTime(purchase.date);
            const purchaseId = purchase.purchase_id || purchase.id;
            const unitCost = purchase.unit_cost || (purchase.total_cost / purchase.quantity) || 0;
            totalCost += purchase.total_cost;
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2">
                        <div class="text-sm font-medium">${formatted.date}</div>
                        <div class="text-xs text-gray-500">${formatted.time}</div>
                    </td>
                    <td class="border border-gray-200 px-4 py-2 text-sm">${purchaseId}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">${purchase.product_name}</td>
                    <td class="border border-gray-200 px-4 py-2">${purchase.quantity}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${unitCost.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${purchase.total_cost.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2">
                        <button class="delete-purchase text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                data-id="${purchaseId}">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        totalCostEl.textContent = `‚Çπ${totalCost.toFixed(2)}`;
    }

    function applyPurchaseFilters() {
        const dateFrom = document.getElementById('purchase-date-from').value;
        const dateTo = document.getElementById('purchase-date-to').value;
        const productId = document.getElementById('purchase-product-filter').value;
        
        let filteredData = allPurchasesData;
        
        // Filter by date range
        if (dateFrom) {
            filteredData = filteredData.filter(purchase => {
                const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                return purchaseDate >= dateFrom;
            });
        }
        
        if (dateTo) {
            filteredData = filteredData.filter(purchase => {
                const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                return purchaseDate <= dateTo;
            });
        }
        
        // Filter by product
        if (productId) {
            filteredData = filteredData.filter(purchase => purchase.product_id == productId);
        }
        
        displayFilteredPurchaseData(filteredData);
    }

    function clearPurchaseFilters() {
        document.getElementById('purchase-date-from').value = '';
        document.getElementById('purchase-date-to').value = '';
        document.getElementById('purchase-product-filter').value = '';
        displayFilteredPurchaseData(allPurchasesData);
    }

    // ===== CART FUNCTIONS WITH STOCK CHECK =====
    function updateCartUI() {
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const whatsappCheckoutButtonEl = document.getElementById('whatsapp-checkout-button');
        
        cartItemsEl.innerHTML = '';
        let total = 0;
        let totalCount = 0;

        for (const productId in cart) {
            if (cart[productId] > 0) {
                const product = products.find(p => p.id === parseInt(productId));
                if (product) {
                    const quantity = cart[productId];
                    const itemTotal = quantity * product.price;
                    total += itemTotal;
                    totalCount += quantity;

                    const cartItem = document.createElement('div');
                    cartItem.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
                    cartItem.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${product.name}</div>
                            <div class="text-sm text-gray-600">‚Çπ${product.price.toFixed(2)} each</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="decrease-quantity w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors" 
                                    data-id="${product.id}">
                                -
                            </button>
                            <span class="quantity-display w-8 text-center font-medium">${quantity}</span>
                            <button class="increase-quantity w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors" 
                                    data-id="${product.id}">
                                +
                            </button>
                        </div>
                        <div class="text-right ml-4">
                            <div class="font-medium text-gray-800">‚Çπ${itemTotal.toFixed(2)}</div>
                            <button class="remove-item text-xs text-red-500 hover:text-red-700 mt-1" data-id="${product.id}">
                                Remove
                            </button>
                        </div>
                    `;
                    cartItemsEl.appendChild(cartItem);
                }
            }
        }

        cartTotalEl.textContent = `‚Çπ${total.toFixed(2)}`;
        whatsappCheckoutButtonEl.disabled = totalCount === 0;
        whatsappCheckoutButtonEl.className = totalCount === 0 
            ? "w-full mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed"
            : "w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300";
    }

    function addToCart(productId) {
        const product = products.find(p => p.id === parseInt(productId));
        
        if (!product) {
            showNotification("Product not found!");
            return;
        }
        
        // Check if product has stock
        if (product.stock <= 0) {
            showNotification(`Sorry, ${product.name} is out of stock!`);
            return;
        }
        
        // Check if adding this item would exceed available stock
        const currentCartQuantity = cart[productId] || 0;
        if (currentCartQuantity + 1 > product.stock) {
            showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
            return;
        }
        
        cart[productId] = currentCartQuantity + 1;
        updateCartUI();
        showNotification(`Added ${product.name} to cart!`);
    }

    function increaseQuantity(productId) {
        const product = products.find(p => p.id === parseInt(productId));
        
        if (!product) {
            showNotification("Product not found!");
            return;
        }
        
        // Check if increasing quantity would exceed available stock
        const currentCartQuantity = cart[productId] || 0;
        if (currentCartQuantity + 1 > product.stock) {
            showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
            return;
        }
        
        cart[productId] = currentCartQuantity + 1;
        updateCartUI();
    }

    function decreaseQuantity(productId) {
        if (cart[productId] > 1) {
            cart[productId] -= 1;
            updateCartUI();
        }
    }

    // ===== SALES PAGE FUNCTIONS =====
    async function fetchProducts() {
        console.log(`üîç Fetching from: ${backendURL}/products`);
        
        try {
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            console.log(`üìä Status: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            products = await response.json();
            console.log("‚úÖ Products fetched:", products.length, "items");
            
            if (!Array.isArray(products) || products.length === 0) {
                throw new Error("No products received");
            }
            
            renderProducts();
            showCartButton();
            await loadSalesHistory();
            
        } catch (error) {
            console.error("üí• Fetch error:", error);
            loadMockProducts();
        }
    }

    function loadMockProducts() {
        console.log('üîÑ Loading mock products');
        products = [
            {id: 1, name: "Apple", price: 100.00, stock: 5, imageUrl: "https://placehold.co/400x400/81c784/ffffff?text=Apple"},
            {id: 2, name: "Banana", price: 50.00, stock: 0, imageUrl: "https://placehold.co/400x400/fff176/ffffff?text=Banana"},
            {id: 3, name: "Orange", price: 80.00, stock: 3, imageUrl: "https://placehold.co/400x400/ffb74d/ffffff?text=Orange"},
            {id: 4, name: "Milk", price: 65.00, stock: 10, imageUrl: "https://placehold.co/400x400/b0e0e6/ffffff?text=Milk"},
            {id: 5, name: "Bread", price: 40.00, stock: 0, imageUrl: "https://placehold.co/400x400/d7ccc8/ffffff?text=Bread"},
            {id: 6, name: "Eggs", price: 90.00, stock: 12, imageUrl: "https://placehold.co/400x400/fff9c4/ffffff?text=Eggs"},
        ];
        renderProducts();
        showCartButton();
    }

    function renderProducts() {
        const productListEl = document.getElementById('product-list');
        if (!products || products.length === 0) {
            productListEl.innerHTML = '<p class="text-center text-gray-500">No products available</p>';
            return;
        }
        
        productListEl.innerHTML = products.map(product => {
            const isOutOfStock = product.stock <= 0;
            const buttonClass = isOutOfStock 
                ? "w-full bg-gray-400 text-white text-xs font-bold py-2 px-3 rounded-lg cursor-not-allowed" 
                : "w-full bg-blue-500 text-white text-xs font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors duration-300";
            const buttonText = isOutOfStock ? "Out of Stock" : "Add to Cart";
            
            return `
                <div class="bg-white p-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 ${isOutOfStock ? 'opacity-70' : ''}">
                    <img src="${product.imageUrl}" alt="${product.name}" 
                         class="w-full h-28 object-cover rounded-md mb-2"
                         onerror="this.src='https://placehold.co/400x400/cccccc/ffffff?text=Product'">
                    <h4 class="text-sm font-semibold text-gray-700">${product.name}</h4>
                    <p class="text-lg font-bold text-gray-800 my-1">‚Çπ${product.price.toFixed(2)}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                        <span>Stock: ${product.stock}</span>
                        ${isOutOfStock ? '<span class="text-red-500 font-bold">Out of Stock</span>' : ''}
                    </div>
                    <button class="add-to-cart-btn mt-2 ${buttonClass}" 
                            data-id="${product.id}" 
                            ${isOutOfStock ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            `;
        }).join('');
    }

    function showCartButton() {
        const existingButton = document.querySelector('.view-cart-button');
        if (existingButton) {
            existingButton.remove();
        }
        
        const cartButton = document.createElement('button');
        cartButton.className = 'view-cart-button fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors z-10';
        cartButton.innerHTML = 'üõí View Cart';
        cartButton.onclick = () => {
            document.getElementById('cart-modal').classList.remove('hidden');
            document.getElementById('cart-modal').classList.add('flex');
        };
        
        document.getElementById('page-sales').appendChild(cartButton);
    }

    async function recordSale(saleItems) {
        console.log('üì¶ Recording sale items:', saleItems);
        
        try {
            for (const item of saleItems) {
                const response = await fetch(`${backendURL}/sales/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        product_id: item.product_id,
                        quantity: item.quantity
                    })
                });

                console.log(`üìä Response for product ${item.product_id}: ${response.status}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.log(`‚ùå Failed for product ${item.product_id}:`, errorData);
                    throw new Error(`Failed to record sale for ${item.product_name}`);
                }
                
                const result = await response.json();
                console.log(`‚úÖ Sale recorded for ${item.product_name}:`, result);
            }
            
            return { message: "All sales recorded successfully" };
            
        } catch (error) {
            console.error('Error recording sale:', error);
            throw error;
        }
    }

    function generateWhatsAppOrder() {
        const phoneNumber = WHATSAPP_NUMBER; 
        let message = "Hi, I would like to place an order:%0a%0a";
        let total = 0;
        const saleItems = [];

        for (const productId in cart) {
            if (cart[productId] > 0) {
                const product = products.find(p => p.id === parseInt(productId));
                if (product) {
                    const quantity = cart[productId];
                    const itemTotal = quantity * product.price;
                    total += itemTotal;
                    message += `‚Ä¢ ${quantity}x ${product.name} - ‚Çπ${itemTotal.toFixed(2)}%0a`;
                    
                    saleItems.push({
                        product_id: product.id,
                        product_name: product.name,
                        quantity: quantity,
                        price: product.price,
                        total: itemTotal
                    });
                }
            }
        }

        message += `%0a*Total: ‚Çπ${total.toFixed(2)}*%0a%0aPlease confirm my order. Thank you!`;

        if (saleItems.length > 0) {
            recordSale(saleItems).then(result => {
                console.log('‚úÖ Sales recorded in database:', result);
                showNotification('Order recorded successfully!');
            }).catch(error => {
                console.warn('‚ö†Ô∏è Sale recording failed, but continuing to WhatsApp:', error);
                showNotification('Order sent to WhatsApp (database recording failed)');
            });
        }

        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
        window.open(whatsappUrl, '_blank');
        
        cart = {};
        updateCartUI();
        document.getElementById('cart-modal').classList.add('hidden');
        document.getElementById('cart-modal').classList.remove('flex');
    }

    // ===== SALES HISTORY DISPLAY =====
    async function loadSalesHistory() {
        try {
            const response = await fetch(`${backendURL}/ledger/sales`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (response.ok) {
                const sales = await response.json();
                
                let salesHistoryEl = document.getElementById('sales-history');
                if (!salesHistoryEl) {
                    salesHistoryEl = document.createElement('div');
                    salesHistoryEl.id = 'sales-history';
                    salesHistoryEl.className = 'bg-white p-6 rounded-lg shadow-lg mt-6';
                    salesHistoryEl.innerHTML = '<h3 class="text-lg font-semibold mb-4">Recent Sales</h3><div id="sales-history-content"></div>';
                    document.getElementById('page-sales').querySelector('main').appendChild(salesHistoryEl);
                }
                
                const salesContentEl = document.getElementById('sales-history-content');
                if (sales.length === 0) {
                    salesContentEl.innerHTML = '<p class="text-gray-500 text-center">No sales history found</p>';
                    return;
                }
                
                salesContentEl.innerHTML = sales.slice(0, 10).map(sale => {
                    const formatted = formatDateTime(sale.date);
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
                            <div class="flex-1">
                                <div class="font-medium">${sale.product_name}</div>
                                <div class="text-sm text-gray-500">${formatted.date}</div>
                                <div class="text-xs text-gray-400">${formatted.time}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-medium">${sale.quantity} units</div>
                                <div class="text-sm text-blue-600">‚Çπ${sale.total_amount.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading sales history:', error);
        }
    }

    // ===== PURCHASE PAGE FUNCTIONS =====
    async function loadPurchasePage() {
        await loadProductDropdown('purchase-product');
        await loadPurchaseHistory();
    }

    // ===== ADD THIS FUNCTION TO YOUR EXISTING JAVASCRIPT =====
    async function loadProductDropdownForFilter(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) {
            console.error(`Dropdown with ID '${dropdownId}' not found`);
            return;
        }
        
        try {
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (response.ok) {
                const products = await response.json();
                dropdown.innerHTML = '<option value="">All Products</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    dropdown.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading products for filter:', error);
            dropdown.innerHTML = '<option value="">Error loading products</option>';
        }
    }

    // ===== FIXED PURCHASE HISTORY =====
    async function loadPurchaseHistory() {
        const historyEl = document.getElementById('purchase-history');
        historyEl.innerHTML = '<p class="text-gray-500 text-center">Loading purchase history...</p>';
        
        try {
            const response = await fetch(`${backendURL}/ledger/purchases`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch purchase history');
            
            const purchases = await response.json();
            
            if (purchases.length === 0) {
                historyEl.innerHTML = '<p class="text-gray-500 text-center">No purchase history found</p>';
                return;
            }
            
            historyEl.innerHTML = purchases.slice(0, 10).map(purchase => {
                const formatted = formatDateTime(purchase.date);
                console.log(`üïí UTC from DB: ${purchase.date} ‚Üí IST: ${formatted.time}`);
                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium">${purchase.product_name}</div>
                            <div class="text-sm text-gray-500">${formatted.date}</div>
                            <div class="text-xs text-gray-400">${formatted.time}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${purchase.quantity} units</div>
                            <div class="text-sm text-green-600">‚Çπ${purchase.total_cost.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading purchase history:', error);
            historyEl.innerHTML = '<p class="text-red-500 text-center">Error loading purchase history</p>';
        }
    }

    // ===== CREATE PRODUCT PAGE FUNCTIONS =====
    async function loadCreatePage() {
        await loadExistingProducts();
    }

    async function loadExistingProducts() {
        const productsEl = document.getElementById('existing-products');
        productsEl.innerHTML = '<p class="text-gray-500 text-center">Loading products...</p>';
        
        try {
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch products');
            
            const products = await response.json();
            
            if (products.length === 0) {
                productsEl.innerHTML = '<p class="text-gray-500 text-center">No products found. Create your first product!</p>';
                return;
            }
            
            productsEl.innerHTML = products.map(product => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-500">Stock: ${product.stock || 0}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">‚Çπ${product.price.toFixed(2)}</div>
                        <div class="text-xs text-gray-500">ID: ${product.id}</div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading products:', error);
            productsEl.innerHTML = '<p class="text-red-500 text-center">Error loading products</p>';
        }
    }

    async function createProduct(productData) {
        console.log('‚ûï Creating product:', productData);
        
        try {
            const response = await fetch(`${backendURL}/products/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(productData)
            });

            console.log(`üìä Response: ${response.status}`);
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to create product');
            }
            
            const result = await response.json();
            console.log('‚úÖ Product created successfully:', result);
            return result;
            
        } catch (error) {
            console.error('Error creating product:', error);
            throw error;
        }
    }

    // ===== IMPROVED DELETE FUNCTIONS =====
    async function deleteRecord(recordId, recordType) {
        if (!recordId || recordId === 'undefined') {
            alert('Cannot delete this record: No valid ID found');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete this ${recordType} record? This action cannot be undone and will adjust product stock.`)) {
            return;
        }
        
        try {
            const endpoint = recordType === 'sale' ? 'sales' : 'purchases';
            const deleteURL = `${backendURL}/${endpoint}/${recordId}`;
            
            console.log(`üóëÔ∏è Attempting to delete ${recordType} from: ${deleteURL}`);
            
            const response = await fetch(deleteURL, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            console.log(`üìä Delete response status: ${response.status}`);
            
            if (response.ok) {
                const result = await response.json();
                showNotification(result.message || `${recordType.charAt(0).toUpperCase() + recordType.slice(1)} record deleted successfully!`);
                
                // Reload the current ledger page
                if (recordType === 'sale') {
                    await loadSalesLedger();
                } else {
                    await loadPurchaseLedger();
                }
            } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Server returned ${response.status}`);
            }
            
        } catch (error) {
            console.error(`Error deleting ${recordType}:`, error);
            alert(`Error deleting ${recordType} record: ${error.message}`);
        }
    }

    // ===== UTILITY FUNCTIONS =====
    function showNotification(message) {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) existingNotification.remove();
        
        const notification = document.createElement('div');
        notification.className = 'notification fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
        backButton.addEventListener('click', backToHome);

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-to-cart-btn')) {
                const productId = e.target.dataset.id;
                addToCart(productId);
            }
            
            if (e.target.classList.contains('increase-quantity')) {
                const productId = e.target.dataset.id;
                increaseQuantity(productId);
            }
            
            if (e.target.classList.contains('decrease-quantity')) {
                const productId = e.target.dataset.id;
                decreaseQuantity(productId);
            }
            
            if (e.target.classList.contains('remove-item')) {
                const productId = e.target.dataset.id;
                if (cart[productId]) {
                    delete cart[productId];
                    updateCartUI();
                    showNotification('Item removed from cart');
                }
            }
            
            // Handle delete buttons for sales and purchases
            if (e.target.classList.contains('delete-sale')) {
                const recordId = e.target.dataset.id;
                deleteRecord(recordId, 'sale');
            }
            
            if (e.target.classList.contains('delete-purchase')) {
                const recordId = e.target.dataset.id;
                deleteRecord(recordId, 'purchase');
            }
            
            // NEW: Handle delete product buttons
            if (e.target.classList.contains('delete-product-btn')) {
                const productId = e.target.dataset.id;
                const productName = e.target.dataset.name;
                deleteProduct(productId, productName);
            }
        });

        document.getElementById('close-modal-button').addEventListener('click', () => {
            document.getElementById('cart-modal').classList.add('hidden');
            document.getElementById('cart-modal').classList.remove('flex');
        });

        document.getElementById('whatsapp-checkout-button').addEventListener('click', generateWhatsAppOrder);

        document.getElementById('purchase-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('purchase-product').value;
            const quantity = document.getElementById('purchase-quantity').value;
            const unitCost = document.getElementById('purchase-unit-cost').value;
            
            if (!productId) {
                alert('Please select a product');
                return;
            }
            
            try {
                const response = await fetch(`${backendURL}/purchases/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        quantity: parseInt(quantity),
                        unit_cost: parseFloat(unitCost)
                    })
                });
                
                if (response.ok) {
                    alert('Purchase recorded successfully!');
                    document.getElementById('purchase-form').reset();
                    await loadPurchaseHistory();
                    await loadProductDropdown('purchase-product');
                } else {
                    const errorData = await response.json();
                    alert('Error recording purchase: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error recording purchase: ' + error.message);
            }
        });

        document.getElementById('create-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const stock = document.getElementById('product-stock').value;
            
            try {
                await createProduct({
                    name: name,
                    price: parseFloat(price),
                    stock: parseInt(stock) || 0
                });
                
                alert('Product created successfully!');
                document.getElementById('create-product-form').reset();
                await loadExistingProducts();
                
            } catch (error) {
                alert('Error creating product: ' + error.message);
            }
        });

        backToHome();
    });
</script>
</body>
</html>